<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEPA DAG Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #0066cc;
            --accent-hover: #0052a3;
            --card-shadow: 0 2px 8px rgba(0,0,0,0.1);
            --best-color: #06b6d4;
            --pareto-color: #f97316;
            --normal-color: #9ca3af;
        }

        body.dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #e4e4e4;
            --text-secondary: #a0a0a0;
            --border-color: #404040;
            --accent-color: #4da3ff;
            --accent-hover: #66b3ff;
            --card-shadow: 0 2px 8px rgba(0,0,0,0.4);
            --best-color: #22d3ee;
            --pareto-color: #fb923c;
            --normal-color: #6b7280;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
        }

        header {
            background-color: var(--bg-primary);
            padding: 1.5rem 0;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
        }

        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .back-link {
            color: var(--accent-color);
            text-decoration: none;
            font-size: 1.5rem;
        }

        .back-link:hover {
            color: var(--accent-hover);
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .theme-toggle {
            background: none;
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .controls {
            background-color: var(--bg-primary);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .controls label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .controls select {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .controls button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }

        .controls button:hover {
            background-color: var(--accent-hover);
        }

        .legend {
            display: flex;
            gap: 1.5rem;
            margin-left: auto;
            align-items: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
        }

        .tree-container {
            background-color: var(--bg-primary);
            margin: 1rem;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
            overflow: visible;
            position: relative;
            min-height: 600px;
        }

        #dag-svg {
            display: block;
            width: 100%;
            height: auto;
        }

        .node circle {
            stroke-width: 3px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .node:hover circle {
            stroke-width: 4px;
            r: 12;
        }

        .node.best circle {
            fill: var(--best-color);
            stroke: var(--best-color);
        }

        .node.pareto circle {
            fill: var(--pareto-color);
            stroke: var(--pareto-color);
        }

        .node.normal circle {
            fill: var(--normal-color);
            stroke: var(--normal-color);
        }

        .node.selected circle {
            stroke: #fbbf24;
            stroke-width: 5px;
        }

        .node text {
            font-size: 11px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            fill: var(--text-primary);
            pointer-events: none;
            font-weight: 600;
        }

        .link {
            fill: none;
            stroke: var(--border-color);
            stroke-width: 2px;
            marker-end: url(#arrowhead);
        }

        .link.highlighted {
            stroke: #fbbf24;
            stroke-width: 3px;
        }

        .tooltip {
            position: absolute;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.75rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: var(--card-shadow);
            z-index: 1000;
            max-width: 300px;
        }

        .tooltip.active {
            opacity: 1;
        }

        .tooltip-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .tooltip-info {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .strategy-panel {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 400px;
            background-color: var(--bg-primary);
            border-left: 1px solid var(--border-color);
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            transform: translateX(100%);
            transition: transform 0.3s;
            overflow-y: auto;
            z-index: 100;
            padding: 2rem;
        }

        body.dark-mode .strategy-panel {
            box-shadow: -2px 0 8px rgba(0,0,0,0.4);
        }

        .strategy-panel.active {
            transform: translateX(0);
        }

        .close-panel {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-panel:hover {
            color: var(--text-primary);
        }

        .strategy-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
            padding-right: 2rem;
        }

        .strategy-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .strategy-metric {
            background-color: var(--bg-secondary);
            padding: 0.75rem;
            border-radius: 6px;
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 0.25rem;
        }

        .strategy-text-container {
            margin-top: 1.5rem;
        }

        .strategy-text-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .strategy-text {
            background-color: var(--bg-secondary);
            padding: 1rem;
            border-radius: 6px;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem;
            border: 1px solid #f5c6cb;
        }

        body.dark-mode .error {
            background-color: #4a1f1f;
            color: #f8d7da;
            border-color: #6b2a2a;
        }

        @media (max-width: 768px) {
            header .container {
                padding: 0 1rem;
            }

            .controls {
                padding: 1rem;
            }

            h1 {
                font-size: 1.2rem;
            }

            .strategy-panel {
                width: 100%;
            }

            .tree-container {
                margin: 0.5rem;
            }

            .legend {
                flex-basis: 100%;
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-left">
                <a href="gepa-viewer.html" class="back-link" id="back-link">←</a>
                <h1 id="run-title">DAG Visualization</h1>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">🌓 Toggle Theme</button>
        </div>
    </header>

    <div class="controls">
        <label>Layout:</label>
        <select id="layout-select" onchange="updateLayout()">
            <option value="hierarchical">Hierarchical (Top-Down)</option>
            <option value="force">Force-Directed</option>
        </select>
        <button onclick="resetZoom()">Reset Zoom</button>
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: var(--best-color);"></div>
                <span>Best</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: var(--pareto-color);"></div>
                <span>Pareto Front</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: var(--normal-color);"></div>
                <span>Normal</span>
            </div>
        </div>
    </div>

    <div id="error-container"></div>
    <div id="loading" class="loading">Loading DAG structure...</div>

    <div class="tree-container" id="tree-container" style="display: none;">
        <svg id="dag-svg">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="var(--border-color)" />
                </marker>
            </defs>
        </svg>
    </div>

    <div class="tooltip" id="tooltip">
        <div class="tooltip-title" id="tooltip-title"></div>
        <div class="tooltip-info" id="tooltip-info"></div>
    </div>

    <div class="strategy-panel" id="strategy-panel">
        <button class="close-panel" onclick="closePanel()">×</button>
        <div class="strategy-title" id="panel-title">Candidate Details</div>
        <div class="strategy-metrics" id="panel-metrics"></div>
        <div class="strategy-text-container">
            <div class="strategy-text-label">Strategy:</div>
            <div class="strategy-text" id="panel-strategy"></div>
        </div>
    </div>

    <script>
        let dagData = null;
        let candidates = null;
        let nodes = [];
        let links = [];
        let svg = null;
        let g = null;
        let zoom = null;
        let currentLayout = 'hierarchical';
        let runName = null;
        let selectedNode = null;
        let simulation = null;

        // Theme management
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            if (dagData) renderDAG();
        }

        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
        }

        // Get run name from URL
        function getRunName() {
            const params = new URLSearchParams(window.location.search);
            return params.get('run');
        }

        // Load DAG and candidates data
        async function loadData() {
            runName = getRunName();
            if (!runName) {
                showError('No run specified in URL');
                document.getElementById('loading').style.display = 'none';
                return;
            }

            document.getElementById('run-title').textContent = `DAG: ${runName}`;
            document.getElementById('back-link').href = `gepa-viewer.html?run=${encodeURIComponent(runName)}`;

            try {
                // Load tree structure
                const treeResponse = await fetch(`data/gepa/runs/${runName}/tree_structure.json`);
                if (!treeResponse.ok) throw new Error('Failed to load tree structure');
                dagData = await treeResponse.json();

                // Load candidates
                const candidatesResponse = await fetch(`data/gepa/runs/${runName}/candidates.json`);
                if (!candidatesResponse.ok) throw new Error('Failed to load candidates');
                candidates = await candidatesResponse.json();

                buildGraph();
                initializeVisualization();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('tree-container').style.display = 'block';
            } catch (error) {
                console.error('Error loading data:', error);
                showError(`Failed to load data: ${error.message}`);
                document.getElementById('loading').style.display = 'none';
            }
        }

        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `<div class="error">${message}</div>`;
        }

        function buildGraph() {
            const numNodes = dagData.num_candidates;
            const bestIdx = dagData.best_idx;

            // Calculate Pareto front (nodes not dominated by any other node)
            const paretoFront = new Set();
            for (let i = 0; i < numNodes; i++) {
                let isDominated = false;
                for (let j = 0; j < numNodes; j++) {
                    if (i !== j && dagData.scores[j] > dagData.scores[i]) {
                        // Check if j is an ancestor or same generation
                        isDominated = true;
                        break;
                    }
                }
                if (!isDominated && dagData.scores[i] > 0.8) { // High-scoring nodes
                    paretoFront.add(i);
                }
            }

            // Build nodes
            nodes = [];
            for (let i = 0; i < numNodes; i++) {
                let nodeType = 'normal';
                if (i === bestIdx) {
                    nodeType = 'best';
                } else if (paretoFront.has(i)) {
                    nodeType = 'pareto';
                }

                nodes.push({
                    id: i,
                    index: i,
                    score: dagData.scores[i],
                    parents: dagData.parents[i],
                    type: nodeType,
                    candidate: candidates.candidates[i]
                });
            }

            // Build links (edges from parent to child)
            links = [];
            for (let i = 0; i < numNodes; i++) {
                const parentList = dagData.parents[i];
                if (parentList && parentList[0] !== null) {
                    for (const parent of parentList) {
                        links.push({
                            source: parent,
                            target: i
                        });
                    }
                }
            }
        }

        function initializeVisualization() {
            const container = document.getElementById('tree-container');
            const width = container.clientWidth || window.innerWidth - 32;
            const height = Math.max(600, window.innerHeight - 250);

            svg = d3.select('#dag-svg')
                .attr('width', width)
                .attr('height', height)
                .attr('viewBox', `0 0 ${width} ${height}`)
                .attr('preserveAspectRatio', 'xMidYMid meet');

            // Update arrowhead color for dark mode
            const isDark = document.body.classList.contains('dark-mode');
            d3.select('#arrowhead polygon')
                .attr('fill', isDark ? '#404040' : '#dee2e6');

            zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);
            g = svg.select('g');
            if (g.empty()) {
                g = svg.append('g');
            }

            renderDAG();
        }

        function renderDAG() {
            const width = parseInt(svg.attr('width'));
            const height = parseInt(svg.attr('height'));

            g.selectAll('*').remove();

            if (currentLayout === 'hierarchical') {
                renderHierarchical(width, height);
            } else {
                renderForceDirected(width, height);
            }
        }

        function renderHierarchical(width, height) {
            // Calculate node depths (generation/level)
            const depths = new Array(nodes.length).fill(0);
            const visited = new Set();

            function calculateDepth(nodeId) {
                if (visited.has(nodeId)) return depths[nodeId];
                visited.add(nodeId);

                const parents = dagData.parents[nodeId];
                if (!parents || parents[0] === null) {
                    depths[nodeId] = 0;
                } else {
                    depths[nodeId] = Math.max(...parents.map(p => calculateDepth(p))) + 1;
                }
                return depths[nodeId];
            }

            nodes.forEach((node, i) => calculateDepth(i));

            const maxDepth = Math.max(...depths);

            // Position nodes
            const nodesAtDepth = {};
            nodes.forEach((node, i) => {
                const depth = depths[i];
                if (!nodesAtDepth[depth]) nodesAtDepth[depth] = [];
                nodesAtDepth[depth].push(i);
            });

            nodes.forEach((node, i) => {
                const depth = depths[i];
                const nodesInLevel = nodesAtDepth[depth];
                const indexInLevel = nodesInLevel.indexOf(i);

                node.x = (width / (nodesInLevel.length + 1)) * (indexInLevel + 1);
                node.y = (height / (maxDepth + 2)) * (depth + 1);
            });

            drawGraph();
        }

        function renderForceDirected(width, height) {
            if (simulation) simulation.stop();

            simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(30));

            simulation.on('tick', () => {
                updatePositions();
            });

            drawGraph();
        }

        function drawGraph() {
            const isDark = document.body.classList.contains('dark-mode');

            // Draw links
            const linkSelection = g.selectAll('.link')
                .data(links)
                .join('path')
                .attr('class', 'link')
                .attr('d', d => {
                    const source = nodes[d.source.id !== undefined ? d.source.id : d.source];
                    const target = nodes[d.target.id !== undefined ? d.target.id : d.target];
                    return `M ${source.x} ${source.y} L ${target.x} ${target.y}`;
                });

            // Draw nodes
            const nodeSelection = g.selectAll('.node')
                .data(nodes)
                .join('g')
                .attr('class', d => `node ${d.type}`)
                .attr('transform', d => `translate(${d.x},${d.y})`)
                .on('click', (event, d) => {
                    showStrategy(d);
                    highlightPath(d);
                })
                .on('mouseover', (event, d) => {
                    showTooltip(event, d);
                })
                .on('mouseout', hideTooltip);

            nodeSelection.append('circle')
                .attr('r', d => 8 + (d.score * 4));

            nodeSelection.append('text')
                .attr('dy', '-12')
                .attr('text-anchor', 'middle')
                .text(d => `${d.id}`);

            nodeSelection.append('text')
                .attr('dy', '18')
                .attr('text-anchor', 'middle')
                .style('font-size', '10px')
                .style('fill', 'var(--text-secondary)')
                .text(d => d.score.toFixed(2));

            if (currentLayout === 'hierarchical') {
                const initialTransform = d3.zoomIdentity.translate(50, 50).scale(0.9);
                svg.call(zoom.transform, initialTransform);
            }
        }

        function updatePositions() {
            g.selectAll('.link')
                .attr('d', d => {
                    return `M ${d.source.x} ${d.source.y} L ${d.target.x} ${d.target.y}`;
                });

            g.selectAll('.node')
                .attr('transform', d => `translate(${d.x},${d.y})`);
        }

        function highlightPath(node) {
            // Reset highlights
            g.selectAll('.node').classed('selected', false);
            g.selectAll('.link').classed('highlighted', false);

            // Highlight selected node
            g.selectAll('.node')
                .filter(d => d.id === node.id)
                .classed('selected', true);

            // Highlight path from root to selected node
            const pathNodes = new Set([node.id]);
            const pathLinks = new Set();

            function tracePath(nodeId) {
                const parents = dagData.parents[nodeId];
                if (parents && parents[0] !== null) {
                    parents.forEach(parentId => {
                        pathNodes.add(parentId);
                        pathLinks.add(`${parentId}-${nodeId}`);
                        tracePath(parentId);
                    });
                }
            }

            tracePath(node.id);

            g.selectAll('.link')
                .filter(d => {
                    const sourceId = d.source.id !== undefined ? d.source.id : d.source;
                    const targetId = d.target.id !== undefined ? d.target.id : d.target;
                    return pathLinks.has(`${sourceId}-${targetId}`);
                })
                .classed('highlighted', true);
        }

        function showTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');
            const title = document.getElementById('tooltip-title');
            const info = document.getElementById('tooltip-info');

            const typeLabel = d.type === 'best' ? ' ⭐ BEST' : d.type === 'pareto' ? ' 🔶 Pareto' : '';
            title.textContent = `Candidate ${d.id}${typeLabel}`;

            const numParents = d.parents && d.parents[0] !== null ? d.parents.length : 0;
            const isMerged = numParents > 1;

            info.innerHTML = `
                <div>Score: ${d.score.toFixed(3)}</div>
                <div>Parents: ${numParents}${isMerged ? ' (merged)' : ''}</div>
                <div>Strategy: ${d.candidate.strategy.substring(0, 80)}...</div>
            `;

            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY + 10 + 'px';
            tooltip.classList.add('active');
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('active');
        }

        function showStrategy(node) {
            const panel = document.getElementById('strategy-panel');
            const title = document.getElementById('panel-title');
            const metrics = document.getElementById('panel-metrics');
            const strategy = document.getElementById('panel-strategy');

            const typeLabel = node.type === 'best' ? ' ⭐ BEST' : node.type === 'pareto' ? ' 🔶 Pareto Front' : '';
            title.textContent = `Candidate ${node.id}${typeLabel}`;

            const numParents = node.parents && node.parents[0] !== null ? node.parents.length : 0;
            const isMerged = numParents > 1;
            const parentsList = isMerged ? node.parents.join(', ') : (numParents === 1 ? node.parents[0] : 'None (Root)');

            metrics.innerHTML = `
                <div class="strategy-metric">
                    <div class="metric-label">Index</div>
                    <div class="metric-value">${node.id}</div>
                </div>
                <div class="strategy-metric">
                    <div class="metric-label">Score</div>
                    <div class="metric-value">${node.score.toFixed(3)}</div>
                </div>
                <div class="strategy-metric">
                    <div class="metric-label">Parents</div>
                    <div class="metric-value">${parentsList}</div>
                </div>
                <div class="strategy-metric">
                    <div class="metric-label">Type</div>
                    <div class="metric-value">${isMerged ? 'Merged' : 'Single'}</div>
                </div>
            `;

            strategy.textContent = node.candidate.strategy;
            panel.classList.add('active');
            selectedNode = node;
        }

        function closePanel() {
            document.getElementById('strategy-panel').classList.remove('active');
            g.selectAll('.node').classed('selected', false);
            g.selectAll('.link').classed('highlighted', false);
            selectedNode = null;
        }

        function updateLayout() {
            currentLayout = document.getElementById('layout-select').value;
            renderDAG();
        }

        function resetZoom() {
            const width = parseInt(svg.attr('width'));
            const height = parseInt(svg.attr('height'));
            const initialTransform = currentLayout === 'hierarchical'
                ? d3.zoomIdentity.translate(50, 50).scale(0.9)
                : d3.zoomIdentity.translate(width / 2, height / 2);
            svg.transition().duration(750).call(zoom.transform, initialTransform);
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            if (dagData) {
                initializeVisualization();
            }
        });

        // Load data on page load
        loadData();
    </script>
</body>
</html>
